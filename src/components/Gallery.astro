---
import siteData from '../data/site.json';

interface GalleryImage {
  src: string;
  alt: string;
}

const galleryImages: GalleryImage[] = siteData.gallery;
---

<section class="gallery section" aria-labelledby="gallery-title" id="gallery">
  <div class="container">
    <h2 id="gallery-title" class="section__title">The Space</h2>
    
    <div class="gallery__grid">
      {galleryImages.map((image, index) => (
        <button
          class="gallery__item"
          type="button"
          data-gallery-trigger
          data-index={index}
          aria-label={`View ${image.alt}`}
        >
          <img 
            src={image.src} 
            alt={image.alt}
            class="gallery__image"
            loading="lazy"
            decoding="async"
          />
          <span class="gallery__overlay" aria-hidden="true">
            <span class="gallery__zoom-icon">⊕</span>
          </span>
        </button>
      ))}
    </div>
  </div>
</section>

<!-- Lightbox Modal -->
<div 
  class="lightbox" 
  id="lightbox" 
  role="dialog" 
  aria-modal="true"
  aria-label="Image gallery viewer"
  aria-hidden="true"
>
  <div class="lightbox__backdrop" data-lightbox-close></div>
  
  <div class="lightbox__content">
    <button 
      class="lightbox__close" 
      data-lightbox-close
      aria-label="Close gallery"
    >
      ✕
    </button>
    
    <button 
      class="lightbox__nav lightbox__nav--prev" 
      data-lightbox-prev
      aria-label="Previous image"
    >
      ←
    </button>
    
    <figure class="lightbox__figure">
      <img 
        class="lightbox__image" 
        id="lightbox-image"
        src="" 
        alt=""
      />
      <figcaption class="lightbox__caption" id="lightbox-caption"></figcaption>
    </figure>
    
    <button 
      class="lightbox__nav lightbox__nav--next" 
      data-lightbox-next
      aria-label="Next image"
    >
      →
    </button>
    
    <div class="lightbox__counter">
      <span id="lightbox-current">1</span> / <span id="lightbox-total">{galleryImages.length}</span>
    </div>
  </div>
</div>

<style>
  .gallery__grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-4);
  }
  
  .gallery__item {
    position: relative;
    aspect-ratio: 4 / 3;
    overflow: hidden;
    border-radius: var(--radius-md);
    border: none;
    padding: 0;
    cursor: pointer;
    background: var(--color-bg-mid);
  }
  
  .gallery__item:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }
  
  .gallery__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-slow), filter var(--transition-normal);
    filter: grayscale(20%) sepia(5%);
  }
  
  .gallery__item:hover .gallery__image,
  .gallery__item:focus-visible .gallery__image {
    transform: scale(1.05);
    filter: grayscale(0%) sepia(0%);
  }
  
  .gallery__overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(26, 26, 24, 0.6);
    opacity: 0;
    transition: opacity var(--transition-fast);
  }
  
  .gallery__item:hover .gallery__overlay,
  .gallery__item:focus-visible .gallery__overlay {
    opacity: 1;
  }
  
  .gallery__zoom-icon {
    font-size: var(--text-2xl);
    color: var(--color-primary);
  }
  
  /* Lightbox Styles */
  .lightbox {
    position: fixed;
    inset: 0;
    z-index: var(--z-modal);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity var(--transition-normal), visibility var(--transition-normal);
  }
  
  .lightbox[aria-hidden="false"] {
    opacity: 1;
    visibility: visible;
  }
  
  .lightbox__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(10, 10, 9, 0.95);
    cursor: pointer;
  }
  
  .lightbox__content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .lightbox__close {
    position: fixed;
    top: var(--space-4);
    right: var(--space-4);
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: 2px solid var(--color-primary);
    border-radius: 50%;
    color: var(--color-primary);
    font-size: var(--text-lg);
    cursor: pointer;
    transition: all var(--transition-fast);
    z-index: 10;
  }
  
  .lightbox__close:hover {
    background: var(--color-primary);
    color: var(--color-text-dark);
  }
  
  .lightbox__close:focus-visible {
    outline: 2px solid var(--color-secondary);
    outline-offset: 2px;
  }
  
  .lightbox__nav {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(42, 42, 38, 0.8);
    border: 1px solid rgba(201, 162, 39, 0.3);
    border-radius: 50%;
    color: var(--color-primary);
    font-size: var(--text-xl);
    cursor: pointer;
    transition: all var(--transition-fast);
    z-index: 10;
  }
  
  .lightbox__nav:hover {
    background: var(--color-primary);
    color: var(--color-text-dark);
    border-color: var(--color-primary);
  }
  
  .lightbox__nav:focus-visible {
    outline: 2px solid var(--color-secondary);
    outline-offset: 2px;
  }
  
  .lightbox__nav--prev {
    left: var(--space-4);
  }
  
  .lightbox__nav--next {
    right: var(--space-4);
  }
  
  .lightbox__figure {
    margin: 0;
    text-align: center;
  }
  
  .lightbox__image {
    max-width: 85vw;
    max-height: 80vh;
    object-fit: contain;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-medium);
  }
  
  .lightbox__caption {
    margin-top: var(--space-4);
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    font-style: italic;
  }
  
  .lightbox__counter {
    position: fixed;
    bottom: var(--space-4);
    left: 50%;
    transform: translateX(-50%);
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    background: rgba(26, 26, 24, 0.8);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-md);
  }
  
  @media (max-width: 768px) {
    .gallery__grid {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3);
    }
    
    .lightbox__nav {
      width: 40px;
      height: 40px;
      font-size: var(--text-lg);
    }
    
    .lightbox__image {
      max-width: 95vw;
      max-height: 70vh;
    }
  }
  
  @media (max-width: 480px) {
    .gallery__grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script define:vars={{ galleryImages: siteData.gallery }}>
  // Lightbox functionality
  document.addEventListener('DOMContentLoaded', () => {
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image');
    const lightboxCaption = document.getElementById('lightbox-caption');
    const lightboxCurrent = document.getElementById('lightbox-current');
    const triggers = document.querySelectorAll('[data-gallery-trigger]');
    const closeButtons = document.querySelectorAll('[data-lightbox-close]');
    const prevButton = document.querySelector('[data-lightbox-prev]');
    const nextButton = document.querySelector('[data-lightbox-next]');
    
    let currentIndex = 0;
    let previouslyFocusedElement = null;
    
    function openLightbox(index) {
      currentIndex = index;
      previouslyFocusedElement = document.activeElement;
      updateLightboxImage();
      lightbox.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      
      // Focus the close button for accessibility
      setTimeout(() => {
        document.querySelector('[data-lightbox-close]').focus();
      }, 100);
    }
    
    function closeLightbox() {
      lightbox.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      
      // Return focus to the trigger
      if (previouslyFocusedElement) {
        previouslyFocusedElement.focus();
      }
    }
    
    function updateLightboxImage() {
      const image = galleryImages[currentIndex];
      lightboxImage.src = image.src;
      lightboxImage.alt = image.alt;
      lightboxCaption.textContent = image.alt;
      lightboxCurrent.textContent = currentIndex + 1;
    }
    
    function nextImage() {
      currentIndex = (currentIndex + 1) % galleryImages.length;
      updateLightboxImage();
    }
    
    function prevImage() {
      currentIndex = (currentIndex - 1 + galleryImages.length) % galleryImages.length;
      updateLightboxImage();
    }
    
    // Event listeners
    triggers.forEach((trigger) => {
      trigger.addEventListener('click', () => {
        const index = parseInt(trigger.getAttribute('data-index'), 10);
        openLightbox(index);
      });
    });
    
    closeButtons.forEach((btn) => {
      btn.addEventListener('click', closeLightbox);
    });
    
    prevButton?.addEventListener('click', prevImage);
    nextButton?.addEventListener('click', nextImage);
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (lightbox.getAttribute('aria-hidden') === 'true') return;
      
      switch (e.key) {
        case 'Escape':
          closeLightbox();
          break;
        case 'ArrowLeft':
          prevImage();
          break;
        case 'ArrowRight':
          nextImage();
          break;
      }
    });
    
    // Trap focus within lightbox
    lightbox.addEventListener('keydown', (e) => {
      if (e.key !== 'Tab') return;
      
      const focusableElements = lightbox.querySelectorAll('button');
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];
      
      if (e.shiftKey && document.activeElement === firstElement) {
        e.preventDefault();
        lastElement.focus();
      } else if (!e.shiftKey && document.activeElement === lastElement) {
        e.preventDefault();
        firstElement.focus();
      }
    });
  });
</script>

